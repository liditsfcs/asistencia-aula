<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Asistencia</title>
  <script type="module">
    // Importar Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";

    // üîë Config Firebase (el tuyo)
const firebaseConfig = {
  apiKey: "AIzaSyCxTeZ8LvP4YMKCV3Ter2n1_Wej0ezYgBQ",
  authDomain: "asistencia-d15e0.firebaseapp.com",
  projectId: "asistencia-d15e0",
  storageBucket: "asistencia-d15e0.firebasestorage.app",
  messagingSenderId: "588035080507",
  appId: "1:588035080507:web:76ff418bb86fccafb0b71e",
  measurementId: "G-7XQHD1MG9G"
};
    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // Coordenadas del aula
    const latAula = -32.48024900029567; //32
    const lonAula = -58.26212864336707;
    const radio = 10; // metros

    // Calcular distancia
    function distancia(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const œÜ1 = lat1 * Math.PI/180;
      const œÜ2 = lat2 * Math.PI/180;
      const ŒîœÜ = (lat2-lat1) * Math.PI/180;
      const ŒîŒª = (lon2-lon1) * Math.PI/180;
      const a = Math.sin(ŒîœÜ/2)**2 + Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    // Login con Google
    window.login = async () => {
      try {
        const result = await signInWithPopup(auth, provider);
        const user = result.user;
        document.getElementById("status").innerText = `Hola, ${user.displayName}`;
        document.getElementById("btnAsistencia").disabled = false;
      } catch (e) {
        alert("Error en login: " + e.message);
      }
    };

    // Logout
    window.logout = async () => {
      await signOut(auth);
      document.getElementById("status").innerText = "No est√°s logueado";
      document.getElementById("btnAsistencia").disabled = true;
    };

    // Registrar asistencia
    window.registrarAsistencia = async () => {
      const user = auth.currentUser;
      if (!user) {
        alert("Primero logueate con Google");
        return;
      }

      navigator.geolocation.getCurrentPosition(async pos => {
        const d = distancia(latAula, lonAula, pos.coords.latitude, pos.coords.longitude);
        if (d > radio) {
          alert("‚ùå No est√°s en el aula.");
          return;
        }

        const uid = user.uid;
        const docRef = doc(db, "asistencias", uid);
        const docSnap = await getDoc(docRef);
        const ahora = Date.now();

        if (docSnap.exists()) {
          const data = docSnap.data();
          if (ahora < data.bloqueadoHasta) {
            const falta = Math.round((data.bloqueadoHasta - ahora)/60000);
            alert(`‚ö†Ô∏è Ya registraste asistencia. Esper√° ${falta} min.`);
            return;
          }
        }

        await setDoc(docRef, {
          uid: uid,
          nombre: user.displayName,
          email: user.email,
          timestamp: ahora,
          bloqueadoHasta: ahora + 10*60*1000 // 10 min
        });

        alert("‚úÖ Asistencia registrada correctamente");
      }, err => {
        alert("Error obteniendo ubicaci√≥n. Activ√° el GPS.");
      });
    };
  </script>
</head>
<body>
  <h2>Registro de Asistencia</h2>
  <p id="status">No est√°s logueado</p>
  <button onclick="login()">Login con Google</button>
  <button onclick="logout()">Logout</button>
  <hr>
  <button id="btnAsistencia" onclick="registrarAsistencia()" disabled>Registrar asistencia</button>
</body>
</html>






