<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Asistencia con Firebase</title>
  <script type="module">
    // Importar SDKs de Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    // üîë Configuraci√≥n de tu proyecto Firebase (copiaste bien esto üëá)
    const firebaseConfig = {
      apiKey: "AIzaSyCxTeZ8LvP4YMKCV3Ter2n1_Wej0ezYgBQ",
      authDomain: "asistencia-d15e0.firebaseapp.com",
      projectId: "asistencia-d15e0",
      storageBucket: "asistencia-d15e0.firebasestorage.app",
      messagingSenderId: "588035080507",
      appId: "1:588035080507:web:76ff418bb86fccafb0b71e",
      measurementId: "G-7XQHD1MG9G"
    };

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Coordenadas del aula
    const latAula = -31.853694;
    const lonAula = -59.023889;
    const radio = 10; // metros

    // Funci√≥n distancia
    function distancia(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const œÜ1 = lat1 * Math.PI/180;
      const œÜ2 = lat2 * Math.PI/180;
      const ŒîœÜ = (lat2-lat1) * Math.PI/180;
      const ŒîŒª = (lon2-lon1) * Math.PI/180;
      const a = Math.sin(ŒîœÜ/2)**2 + Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    // Registrar asistencia
    async function registrarAsistencia(nombre) {
      navigator.geolocation.getCurrentPosition(async pos => {
        const d = distancia(latAula, lonAula, pos.coords.latitude, pos.coords.longitude);

        if (d > radio) {
          alert("No est√°s en el aula.");
          return;
        }

        const docRef = doc(db, "asistencias", nombre);
        const docSnap = await getDoc(docRef);
        const ahora = Date.now();

        if (docSnap.exists()) {
          const data = docSnap.data();
          if (ahora < data.bloqueadoHasta) {
            const falta = Math.round((data.bloqueadoHasta - ahora)/60000);
            alert(`Ya registraste asistencia. Pod√©s volver en ${falta} min.`);
            return;
          }
        }

        await setDoc(docRef, {
          nombre: nombre,
          timestamp: ahora,
          bloqueadoHasta: ahora + 10*60*1000 // 10 min
        });

        alert("‚úÖ Asistencia registrada correctamente");
      }, err => {
        alert("Error obteniendo ubicaci√≥n. Activ√° el GPS.");
      });
    }

    // Capturar bot√≥n
    window.addEventListener("DOMContentLoaded", () => {
      document.getElementById("btn").addEventListener("click", () => {
        const nombre = document.getElementById("nombre").value.trim();
        if (nombre) registrarAsistencia(nombre);
        else alert("Ingres√° tu nombre y apellido");
      });
    });
  </script>
</head>
<body>
  <h2>Registro de Asistencia</h2>
  <input type="text" id="nombre" placeholder="Nombre y apellido">
  <button id="btn">Registrar asistencia</button>
</body>
</html>
